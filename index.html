<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกผลการเรียนรายบุคคล</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1a73e8; --success: #188038; --bg: #f0f2f5; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg); padding: 20px; }
        .container { background: white; max-width: 800px; margin: auto; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { color: var(--primary); text-align: center; margin-bottom: 25px; }
        .section-title { background: #e8f0fe; padding: 10px 15px; border-radius: 6px; margin: 20px 0 10px; font-weight: bold; color: var(--primary); }
        label { display: block; margin-top: 12px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .calc-box { background: #fff9c4; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center; font-weight: bold; }
        button { width: 100%; padding: 15px; margin-top: 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; }
        .btn-main { background: var(--success); color: white; }
        .btn-main:hover { background: #145a2d; }
        #loading { display: none; text-align: center; color: var(--primary); margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f8f9fa; }
    </style>
</head>
<body>

<div class="container">
    <h2>บันทึกข้อมูลและออกรายงาน PDF</h2>
    <form id="attendanceForm">
        <div class="section-title">ส่วนที่ 1: ข้อมูลคุณครูและวิชา</div>
        <div class="grid-2">
            <div><label>ชื่อครูผู้สอน</label><input type="text" id="teacherName" required></div>
            <div>
                <label>กลุ่มสาระฯ</label>
                <select id="department" required>
                    <option value="">--เลือก--</option>
                    <option value="คณิตศาสตร์">คณิตศาสตร์</option>
                    <option value="ภาษาไทย">ภาษาไทย</option>
                    <option value="วิทยาศาสตร์และเทคโนโลยี">วิทยาศาสตร์และเทคโนโลยี</option>
                    <option value="สังคมศึกษาฯ">สังคมศึกษาฯ</option>
                    <option value="ภาษาต่างประเทศ">ภาษาต่างประเทศ</option>
                    <option value="การงานอาชีพ">การงานอาชีพ</option>
                    <option value="สุขศึกษาและพลศึกษา">สุขศึกษาและพลศึกษา</option>
                    <option value="ศิลปะ">ศิลปะ</option>
                </select>
            </div>
        </div>
        <div class="grid-3">
            <div><label>รหัสวิชา</label><input type="text" id="courseID" required></div>
            <div><label>ชื่อวิชา</label><input type="text" id="courseName" required></div>
            <div><label>ชั้น/ห้อง</label><input type="text" id="classRoom" placeholder="ม.1/1" required></div>
        </div>

        <div class="section-title">ส่วนที่ 2: ข้อมูลนักเรียน</div>
        <div class="grid-2">
            <div><label>เลขประจำตัว</label><input type="text" id="studentID" required></div>
            <div><label>ชื่อ-นามสกุลนักเรียน</label><input type="text" id="studentName" required></div>
        </div>
        <div class="grid-2">
            <div><label>เวลาเรียนทั้งหมด (ชม.)</label><input type="number" id="totalTime" value="40" oninput="calculate()"></div>
            <div class="grid-3">
                <div><label>ขาด</label><input type="number" id="absent" value="0" oninput="calculate()"></div>
                <div><label>ลา</label><input type="number" id="leave" value="0" oninput="calculate()"></div>
                <div><label>ป่วย</label><input type="number" id="sick" value="0" oninput="calculate()"></div>
            </div>
        </div>

        <div class="calc-box">
            มาเรียน: <span id="presentText">40</span> ชม. | คิดเป็นร้อยละ: <span id="percentText">100.00</span>%
        </div>

        <button type="submit" class="btn-main">บันทึกข้อมูลและดาวน์โหลด PDF</button>
        <div id="loading">⏳ กำลังบันทึกข้อมูล... กรุณารอสักครู่</div>
    </form>

    <div id="summarySection" style="display:none;">
        <div class="section-title">รายการที่บันทึกแล้วในรอบนี้</div>
        <table>
            <thead>
                <tr><th>ชื่อนักเรียน</th><th>ร้อยละ</th><th>สถานะ</th></tr>
            </thead>
            <tbody id="summaryBody"></tbody>
        </table>
    </div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyF6kvBkIthveFNCiq2KbIlCIMAspCzMdo4mrnkU9Bsoov5GsYHFNRW_05BMPWT8QY/exec';

    function calculate() {
        const total = parseFloat(document.getElementById('totalTime').value) || 0;
        const absent = parseFloat(document.getElementById('absent').value) || 0;
        const leave = parseFloat(document.getElementById('leave').value) || 0;
        const sick = parseFloat(document.getElementById('sick').value) || 0;
        const present = total - (absent + leave + sick);
        const percent = total > 0 ? (present / total * 100).toFixed(2) : 0;
        document.getElementById('presentText').innerText = present;
        document.getElementById('percentText').innerText = percent;
    }

    document.getElementById('attendanceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        document.getElementById('loading').style.display = 'block';
        
        const data = {
            teacher: document.getElementById('teacherName').value,
            dept: document.getElementById('department').value,
            courseID: document.getElementById('courseID').value,
            courseName: document.getElementById('courseName').value,
            class: document.getElementById('classRoom').value,
            studentID: document.getElementById('studentID').value,
            studentName: document.getElementById('studentName').value,
            total: document.getElementById('totalTime').value,
            absent: document.getElementById('absent').value,
            leave: document.getElementById('leave').value,
            sick: document.getElementById('sick').value,
            present: document.getElementById('presentText').innerText,
            percent: document.getElementById('percentText').innerText
        };

        fetch(scriptURL, { method: 'POST', body: JSON.stringify(data) })
        .then(res => res.json())
        .then(res => {
            document.getElementById('loading').style.display = 'none';
            if(res.result === "success") {
                window.open(res.downloadUrl, '_blank');
                document.getElementById('summarySection').style.display = 'block';
                const row = document.getElementById('summaryBody').insertRow(0);
                row.innerHTML = `<td>${data.studentName}</td><td>${data.percent}%</td><td style="color:green">สำเร็จ</td>`;
                
                // ล้างข้อมูลนักเรียนคนเดิมออก
                document.getElementById('studentID').value = '';
                document.getElementById('studentName').value = '';
                document.getElementById('absent').value = '0';
                document.getElementById('leave').value = '0';
                document.getElementById('sick').value = '0';
                calculate();
                document.getElementById('studentID').focus();
            }
        }).catch(() => {
            alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
            document.getElementById('loading').style.display = 'none';
        });
    });
</script>
</body>
</html>