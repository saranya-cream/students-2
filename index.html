<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกผลการเรียน - 8 กลุ่มสาระ</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1a73e8; --success: #188038; --bg: #f8f9fa; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 700px; padding: 30px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        h2 { color: var(--primary); text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .section-title { background: #e8f0fe; padding: 10px; border-radius: 5px; margin-top: 20px; font-weight: bold; color: var(--primary); }
        label { display: block; margin-top: 15px; font-weight: bold; color: #444; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .calc-result { background: #f1f3f4; padding: 15px; border-radius: 10px; margin-top: 15px; border-left: 5px solid var(--primary); text-align: center; }
        .calc-result span { font-weight: bold; font-size: 1.2em; color: var(--primary); }
        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 25px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-submit { background: var(--success); color: white; }
        .btn-submit:hover { background: #136a2e; }
        #loading { display: none; text-align: center; color: var(--primary); font-weight: bold; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <form id="attendanceForm">
        <h2>บันทึกข้อมูลและออกรายงาน PDF</h2>

        <div class="section-title">ข้อมูลพื้นฐาน</div>
        <label>ชื่อครูผู้สอน</label>
        <input type="text" id="teacherName" placeholder="ระบุชื่อ-นามสกุล" required>

        <label>กลุ่มสาระการเรียนรู้</label>
        <select id="department" required>
            <option value="" disabled selected>--- เลือกกลุ่มสาระฯ ---</option>
            <option value="คณิตศาสตร์">คณิตศาสตร์</option>
            <option value="ภาษาไทย">ภาษาไทย</option>
            <option value="วิทยาศาสตร์และเทคโนโลยี">วิทยาศาสตร์และเทคโนโลยี</option>
            <option value="สังคมศึกษา ศาสนา และวัฒนธรรม">สังคมศึกษา ศาสนา และวัฒนธรรม</option>
            <option value="ภาษาต่างประเทศ">ภาษาต่างประเทศ</option>
            <option value="การงานอาชีพ">การงานอาชีพ</option>
            <option value="สุขศึกษาและพลศึกษา">สุขศึกษาและพลศึกษา</option>
            <option value="ศิลปะ">ศิลปะ</option>
        </select>

        <div class="grid-2">
            <div><label>รหัสวิชา</label><input type="text" id="courseID" required></div>
            <div><label>ชื่อรายวิชา</label><input type="text" id="courseName" required></div>
        </div>
        <label>ชั้น/ห้อง</label>
        <input type="text" id="classRoom" placeholder="ม.6/1" required>

        <div class="section-title">ข้อมูลการมาเรียนรายบุคคล</div>
        <div class="grid-2">
            <div><label>เลขประจำตัว</label><input type="text" id="studentID" required></div>
            <div><label>ชื่อ-นามสกุลนักเรียน</label><input type="text" id="studentName" required></div>
        </div>

        <label>เวลาเรียนทั้งหมด (ชม.)</label>
        <input type="number" id="totalTime" value="40" oninput="calculate()" required>

        <div class="grid-3">
            <div><label>ขาด</label><input type="number" id="absent" value="0" oninput="calculate()"></div>
            <div><label>ลา</label><input type="number" id="leave" value="0" oninput="calculate()"></div>
            <div><label>ป่วย</label><input type="number" id="sick" value="0" oninput="calculate()"></div>
        </div>

        <div class="calc-result">
            มาเรียนจริง: <span id="presentText">40</span> ชม. | 
            คิดเป็นร้อยละ: <span id="percentText">100.00</span> %
        </div>

        <div id="loading">⏳ กำลังบันทึกและสร้างไฟล์ PDF...</div>

        <div class="btn-group">
            <button type="submit" class="btn-submit">บันทึกข้อมูลและดาวน์โหลด PDF</button>
            <button type="button" style="background:#ddd;" onclick="location.reload()">ล้างข้อมูล/เริ่มใหม่</button>
        </div>
    </form>
</div>

<script>
    // *** แก้ไข: วาง Web App URL จาก Google Sheets ของคุณที่นี่ ***
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzAr0CCJXhtYJfA_qoW1IsCzPz4swHbbHZ7yLNpp-9Z2zLQLHrUMa5G2iOK-sHXvB8/exec';

    function calculate() {
        const total = parseFloat(document.getElementById('totalTime').value) || 0;
        const absent = parseFloat(document.getElementById('absent').value) || 0;
        const leave = parseFloat(document.getElementById('leave').value) || 0;
        const sick = parseFloat(document.getElementById('sick').value) || 0;

        const present = total - (absent + leave + sick);
        const percentage = total > 0 ? (present / total) * 100 : 0;

        document.getElementById('presentText').innerText = present;
        document.getElementById('percentText').innerText = percentage.toFixed(2);
    }

    document.getElementById('attendanceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        document.getElementById('loading').style.display = 'block';
        
        const data = {
            teacher: document.getElementById('teacherName').value,
            dept: document.getElementById('department').value,
            courseID: document.getElementById('courseID').value,
            courseName: document.getElementById('courseName').value,
            class: document.getElementById('classRoom').value,
            studentID: document.getElementById('studentID').value,
            studentName: document.getElementById('studentName').value,
            total: document.getElementById('totalTime').value,
            absent: document.getElementById('absent').value,
            leave: document.getElementById('leave').value,
            sick: document.getElementById('sick').value,
            present: document.getElementById('presentText').innerText,
            percent: document.getElementById('percentText').innerText
        };

        fetch(scriptURL, { method: 'POST', body: JSON.stringify(data) })
        .then(res => res.json())
        .then(res => {
            document.getElementById('loading').style.display = 'none';
            if(res.result === "success") {
                alert('บันทึกสำเร็จ! กำลังดาวน์โหลด PDF...');
                window.open(res.downloadUrl, '_blank'); // เปิดไฟล์ PDF เพื่อโหลด
                
                // ล้างข้อมูลเฉพาะส่วนนักเรียน เพื่อพิมพ์คนถัดไป
                document.getElementById('studentID').value = '';
                document.getElementById('studentName').value = '';
                document.getElementById('absent').value = '0';
                document.getElementById('leave').value = '0';
                document.getElementById('sick').value = '0';
                calculate();
                document.getElementById('studentID').focus();
            } else {
                alert('Error: ' + res.message);
            }
        })
        .catch(err => {
            alert('ไม่สามารถเชื่อมต่อระบบได้ กรุณาตรวจสอบ URL ของ Apps Script');
            document.getElementById('loading').style.display = 'none';
        });
    });
</script>

</body>
</html>